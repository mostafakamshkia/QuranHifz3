<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0f172a" />
  <title>وردد | صفحة السورة</title>

  <!-- خطوط عربية -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --space-dark: #0f172a;
      --space-light: #1e293b;
      --text-light: #e2e8f0;
      --text-muted: #94a3b8;
      --accent-glow: #facc15;
      --primary-glow: #a78bfa;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "Tajawal", system-ui, sans-serif;
      background-color: var(--space-dark);
      color: var(--text-light);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
      overflow: hidden; /* منع سكرول بسبب الاحتفالات */
    }

    .container { width: min(900px, 90vw); z-index: 10; position: relative; }

    .surah-header { margin-bottom: 24px; }
    .surah-header h1 {
      font-size: clamp(2rem, 10vw, 3.5rem);
      font-weight: 800;
      color: var(--accent-glow);
    }
    .surah-header p { font-size: 1.1rem; color: var(--text-muted); }

    .main-content {
      background-color: var(--space-light);
      border: 1px solid #334155;
      border-radius: 24px;
      padding: 40px 20px;
      margin-bottom: 32px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
    }

    .main-content .placeholder-icon { font-size: 80px; }

    .player-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      width: 100%;
      margin-top: 20px;
    }

    .nav-btn, .play-btn {
      background: var(--space-dark);
      border: 1px solid #475569;
      color: var(--text-light);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 28px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      transition: all 0.2s ease;
      user-select: none;
    }

    .play-btn {
      width: 80px;
      height: 80px;
      font-size: 40px;
      background: var(--primary-glow);
      border: none;
    }

    .nav-btn:hover, .play-btn:hover { transform: scale(1.1); border-color: var(--accent-glow); }
    .nav-btn.disabled { opacity: 0.4; cursor: not-allowed; transform: none; border-color: #475569; }

    .back-button {
      display: inline-block;
      margin-top: 16px;
      color: var(--text-muted);
      text-decoration: none;
      font-weight: 500;
    }
    .back-button:hover { color: var(--text-light); }

    #celebrationCanvas {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; z-index: 100;
    }

    /* زر "اضغط للتشغيل" يظهر فقط لو منع التشغيل التلقائي */
    .tap-to-play {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent-glow);
      color: #0f172a;
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(0,0,0,.25);
      z-index: 200;
    }
    .tap-to-play[hidden] { display: none; }

    @media (prefers-reduced-motion: reduce) {
      #celebrationCanvas { display: none; }
      .nav-btn:hover, .play-btn:hover { transform: none; }
    }
  </style>
</head>
<body>

  <canvas id="celebrationCanvas"></canvas>

  <div class="container">
    <header class="surah-header">
      <h1 id="surahNameEl"></h1>
      <p id="welcomeMessageEl"></p>
    </header>

    <main class="main-content">
      <div class="placeholder-icon">📖</div>
      <p>استمع وكرر الآيات مع الشيخ</p>

      <!-- Autoplay + Loop + Playsinline للهواتف -->
      <audio id="audioPlayer" loop autoplay playsinline preload="auto"></audio>

      <div class="player-controls">
        <a id="prevBtn" class="nav-btn" href="#" aria-label="السورة السابقة">◀</a>
        <button id="playPauseBtn" class="play-btn" aria-label="تشغيل/إيقاف">▶</button>
        <a id="nextBtn" class="nav-btn" href="#" aria-label="السورة التالية">▶</a>
      </div>
    </main>

    <a href="index.html" class="back-button">العودة للفهرس</a>
  </div>

  <!-- يظهر فقط لو التشغيل التلقائي اترفَض -->
  <button id="tapToPlay" class="tap-to-play" hidden>اضغط للتشغيل ▶</button>

  <script>
    // ——— قالب إعدادات سريع ———
    const CONFIG = {
      // audioMode: 'remote' | 'local' | 'auto' (جرّب المحلي ثم يرجع للبعيد)
      audioMode: 'auto',
      localBases: { // لو هترفع ملفاتك
        amma: 'assets/audio/amma',
        tabarak: 'assets/audio/tabarak'
      },
      remoteBase: 'https://server13.mp3quran.net/husr_mua_m/Rewayat-Hafs-A-n-Asem',
      celebration: true
    };

    // ——— بيانات السور ———
    const JUZ_30 = [{num:78,name:'النبأ'},{num:79,name:'النازعات'},{num:80,name:'عبس'},{num:81,name:'التكوير'},{num:82,name:'الانفطار'},{num:83,name:'المطففين'},{num:84,name:'الانشقاق'},{num:85,name:'البروج'},{num:86,name:'الطارق'},{num:87,name:'الأعلى'},{num:88,name:'الغاشية'},{num:89,name:'الفجر'},{num:90,name:'البلد'},{num:91,name:'الشمس'},{num:92,name:'الليل'},{num:93,name:'الضحى'},{num:94,name:'الشرح'},{num:95,name:'التين'},{num:96,name:'العلق'},{num:97,name:'القدر'},{num:98,name:'البينة'},{num:99,name:'الزلزلة'},{num:100,name:'العاديات'},{num:101,name:'القارعة'},{num:102,name:'التكاثر'},{num:103,name:'العصر'},{num:104,name:'الهمزة'},{num:105,name:'الفيل'},{num:106,name:'قريش'},{num:107,name:'الماعون'},{num:108,name:'الكوثر'},{num:109,name:'الكافرون'},{num:110,name:'النصر'},{num:111,name:'المسد'},{num:112,name:'الإخلاص'},{num:113,name:'الفلق'},{num:114,name:'الناس'}];
    const JUZ_29 = [{num:67,name:'الملك'},{num:68,name:'القلم'},{num:69,name:'الحاقة'},{num:70,name:'المعارج'},{num:71,name:'نوح'},{num:72,name:'الجن'},{num:73,name:'المزمل'},{num:74,name:'المدثر'},{num:75,name:'القيامة'},{num:76,name:'الإنسان'},{num:77,name:'المرسلات'}];

    // ——— عناصر ———
    const surahNameEl = document.getElementById('surahNameEl');
    const welcomeMessageEl = document.getElementById('welcomeMessageEl');
    const audioPlayer = document.getElementById('audioPlayer');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const tapToPlay = document.getElementById('tapToPlay');

    // ——— مساعدات ———
    const findByNum = (num) => JUZ_30.concat(JUZ_29).find(s => s.num == num);
    const getJuzByNum = (num) => (num >= 78 ? '30' : '29');
    const pad3 = (n) => String(n).padStart(3, '0');

    function buildLocalUrl(num) {
      const juz = getJuzByNum(num);
      const base = (juz === '30') ? CONFIG.localBases.amma : CONFIG.localBases.tabarak;
      return `${base}/${pad3(num)}.mp3`;
    }
    function buildRemoteUrl(num) {
      return `${CONFIG.remoteBase}/${pad3(num)}.mp3`;
    }

    // ——— تشغيل تلقائي موثوق ———
    let autoplayUnlocked = false;
    function tryPlay() {
      audioPlayer.loop = true;
      return audioPlayer.play().then(() => {
        autoplayUnlocked = true;
        tapToPlay.hidden = true;
        playPauseBtn.textContent = '⏸';
        ['pointerdown','touchstart','keydown','click','visibilitychange'].forEach(ev =>
          document.removeEventListener(ev, unlockOnGesture, true)
        );
      }).catch(() => {
        if (audioPlayer.paused) tapToPlay.hidden = false;
      });
    }
    function unlockOnGesture() { if (!autoplayUnlocked) tryPlay(); }

    // ——— إعداد الصوت بالمصدر المناسب ———
    function setAudioSourceFor(num) {
      let triedLocal = false, triedRemote = false;

      function loadAndPlay(src) {
        audioPlayer.pause();
        audioPlayer.currentTime = 0;
        audioPlayer.src = src;
        audioPlayer.load();
        tryPlay();
      }

      function tryLocalThenRemote() {
        if (!triedLocal) {
          triedLocal = true;
          loadAndPlay(buildLocalUrl(num));
        } else if (!triedRemote) {
          triedRemote = true;
          loadAndPlay(buildRemoteUrl(num));
        }
      }

      function tryRemoteThenLocal() {
        if (!triedRemote) {
          triedRemote = true;
          loadAndPlay(buildRemoteUrl(num));
        } else if (!triedLocal) {
          triedLocal = true;
          loadAndPlay(buildLocalUrl(num));
        }
      }

      // نظّف مستمعات الأخطاء القديمة
      audioPlayer.onerror = null;

      if (CONFIG.audioMode === 'local') {
        loadAndPlay(buildLocalUrl(num));
      } else if (CONFIG.audioMode === 'remote') {
        loadAndPlay(buildRemoteUrl(num));
      } else { // auto
        // جرّب المحلي ثم ارجع للبعيد عند الخطأ
        tryLocalThenRemote();
        audioPlayer.onerror = () => {
          // لو فشل الحالي جرّب الآخر
          if (triedLocal && !triedRemote) {
            tryRemoteThenLocal();
          } else if (triedRemote && !triedLocal) {
            tryLocalThenRemote();
          }
        };
      }
    }

    // ——— تهيئة الصفحة ———
    window.onload = function() {
      const params = new URLSearchParams(window.location.search);

      // دعم ?surah= أو ?num=
      let surahNum = params.get('num') || params.get('surah');
      surahNum = surahNum ? parseInt(surahNum, 10) : null;

      // الاسم إن لم يُمرر
      let surahName = params.get('name');
      if (!surahName && surahNum) {
        const meta = findByNum(surahNum);
        surahName = meta ? meta.name : `رقم ${surahNum}`;
      }

      // الجزء إن لم يُمرر
      let juz = params.get('juz');
      if (!juz && surahNum) juz = getJuzByNum(surahNum);

      const gender = params.get('gender') || localStorage.getItem('selectedGender') || 'boy';

      if (!surahNum || !surahName) {
        surahNameEl.textContent = "خطأ";
        welcomeMessageEl.textContent = "لم يتم تحديد السورة. من فضلك ارجع للفهرس وحاول مرة أخرى.";
        return;
      }

      // معلومات الصفحة
      document.title = `وردد | ${surahName}`;
      surahNameEl.textContent = `سورة ${surahName}`;
      const heroType = gender === 'girl' ? 'الفارسة' : 'الفارس';
      welcomeMessageEl.textContent = `أهلاً بك أيها ${heroType} الصغير، لنقرأ ونردد سويًا.`;

      // إعداد الصوت (تشغيل تلقائي + تكرار)
      setAudioSourceFor(surahNum);
      audioPlayer.addEventListener('canplay', () => { if (!autoplayUnlocked) tryPlay(); });
      document.addEventListener('visibilitychange', unlockOnGesture, true);
      document.addEventListener('pointerdown', unlockOnGesture, true);
      document.addEventListener('touchstart', unlockOnGesture, true);
      document.addEventListener('keydown', unlockOnGesture, true);
      document.addEventListener('click', unlockOnGesture, true);

      // تنقّل السور (لا انتقال تلقائي)
      const surahList = juz === '30' ? JUZ_30 : JUZ_29;
      const currentIndex = surahList.findIndex(s => s.num == surahNum);

      // السابق
      if (currentIndex > 0) {
        const prevSurah = surahList[currentIndex - 1];
        const prevParams = new URLSearchParams({ num: prevSurah.num, name: prevSurah.name, juz, gender });
        prevBtn.href = `surah.html?${prevParams.toString()}`;
      } else {
        prevBtn.classList.add('disabled');
        prevBtn.addEventListener('click', (e) => e.preventDefault());
      }

      // التالي
      if (currentIndex < surahList.length - 1) {
        const nextSurah = surahList[currentIndex + 1];
        const nextParams = new URLSearchParams({ num: nextSurah.num, name: nextSurah.name, juz, gender });
        nextBtn.href = `surah.html?${nextParams.toString()}`;
        nextBtn.addEventListener('click', (e) => {
          e.preventDefault();
          if (CONFIG.celebration) triggerCelebration();
          setTimeout(() => { window.location.href = nextBtn.href; }, CONFIG.celebration ? 800 : 0);
        });
      } else {
        nextBtn.classList.add('disabled');
        nextBtn.addEventListener('click', (e) => e.preventDefault());
      }
    };

    // زر "اضغط للتشغيل" عند منع التشغيل التلقائي
    tapToPlay.addEventListener('click', tryPlay);

    // تشغيل/إيقاف
    playPauseBtn.addEventListener('click', () => {
      if (audioPlayer.paused) audioPlayer.play();
      else audioPlayer.pause();
    });
    audioPlayer.onplay = () => { playPauseBtn.textContent = '⏸'; tapToPlay.hidden = true; };
    audioPlayer.onpause = () => { playPauseBtn.textContent = '▶'; };

    // تأكيد التكرار حتى لو اتغيّرت خاصية loop بالخطأ
    audioPlayer.addEventListener('ended', () => {
      if (!audioPlayer.loop) {
        audioPlayer.currentTime = 0;
        audioPlayer.play();
      }
    });

    // اختصارات لوحة المفاتيح: مسافة تشغيل/إيقاف، الأسهم تنقّل
    document.addEventListener('keydown', (e) => {
      const tag = (e.target && e.target.tagName || '').toLowerCase();
      if (tag === 'input' || tag === 'textarea') return;
      if (e.code === 'Space') {
        e.preventDefault();
        playPauseBtn.click();
      } else if (e.key === 'ArrowLeft') {
        if (!prevBtn.classList.contains('disabled')) window.location.href = prevBtn.href;
      } else if (e.key === 'ArrowRight') {
        if (!nextBtn.classList.contains('disabled')) {
          if (CONFIG.celebration) triggerCelebration();
          setTimeout(() => { window.location.href = nextBtn.href; }, CONFIG.celebration ? 800 : 0);
        }
      }
    });

    // ——— احتفال بسيط ———
    const canvas = document.getElementById('celebrationCanvas');
    const ctx = canvas.getContext('2d');
    let particles = [];

    function triggerCelebration() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      particles = [];
      const particleCount = 200;
      const colors = ['#facc15', '#a78bfa', '#f472b6', '#38bdf8', '#e2e8f0'];

      for (let i = 0; i < particleCount; i++) {
        particles.push({
          x: Math.random() * canvas.width,
          y: canvas.height + Math.random() * 300,
          radius: Math.random() * 5 + 2,
          color: colors[Math.floor(Math.random() * colors.length)],
          speed: Math.random() * 5 + 2,
          alpha: 1
        });
      }
      animateCelebration();
    }

    function animateCelebration() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      for (let i = particles.length - 1; i >= 0; i--) {
        const p = particles[i];
        p.y -= p.speed;
        p.alpha -= 0.01;
        if (p.alpha <= 0) particles.splice(i, 1);

        ctx.beginPath();
        ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(${hexToRgb(p.color)}, ${p.alpha})`;
        ctx.fill();
      }

      if (particles.length > 0) requestAnimationFrame(animateCelebration);
      else ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function hexToRgb(hex) {
      let r = 0, g = 0, b = 0;
      if (hex.length == 4) {
        r = "0x" + hex[1] + hex[1];
        g = "0x" + hex[2] + hex[2];
        b = "0x" + hex[3] + hex[3];
      } else if (hex.length == 7) {
        r = "0x" + hex[1] + hex[2];
        g = "0x" + hex[3] + hex[4];
        b = "0x" + hex[5] + hex[6];
      }
      return `${+r},${+g},${+b}`;
    }
  </script>
</body>
</html>