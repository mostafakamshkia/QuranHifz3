<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>وردد | جاري تحميل السورة...</title>

  <meta name="theme-color" content="#0f172a"/>
  <link rel="manifest" href="manifest.json">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Amiri+Quran&display=swap" rel="stylesheet">

  <style>
    :root {
      --space-dark: #0f172a; --space-light: #1e293b; --text-light: #e2e8f0;
      --text-muted: #94a3b8; --accent-glow: #facc15; --primary-glow: #a78bfa; --ring: rgba(167, 139, 250, 0.4);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Tajawal", system-ui, sans-serif; background-color: var(--space-dark); color: var(--text-light);
      display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; text-align: center; overflow: hidden;
    }
    .container { width: min(900px, 90vw); z-index: 10; position: relative; }
    .surah-header { margin-bottom: 24px; }
    .surah-header h1 { font-size: clamp(2rem, 10vw, 3.5rem); font-weight: 800; color: var(--accent-glow); }
    .surah-header p { font-size: 1.1rem; color: var(--text-muted); }
    .main-content { background-color: var(--space-light); border: 1px solid #334155; border-radius: 24px; padding: 20px; margin-bottom: 24px; }
    .surah-image-container { margin-bottom: 20px; min-height: 200px; }
    .surah-image { max-width: 100%; height: auto; max-height: 40vh; border-radius: 16px; background-color: var(--space-dark); object-fit: contain; }
    #ayahText { font-family: "Amiri Quran", "Noto Naskh Arabic", serif; font-size: clamp(1.8rem, 7vw, 2.5rem); line-height: 2; min-height: 100px; margin-bottom: 24px; }
    .player-controls { display: flex; align-items: center; justify-content: center; gap: 16px; width: 100%; }
    .nav-btn, .play-btn, .repeat-btn { background: var(--space-dark); border: 1px solid #475569; color: var(--text-light); border-radius: 50%; width: 50px; height: 50px; font-size: 24px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; text-decoration: none; transition: all 0.2s ease; }
    .play-btn { width: 70px; height: 70px; font-size: 36px; background: var(--primary-glow); border: none; }
    .repeat-btn.active { background: var(--accent-glow); color: var(--space-dark); box-shadow: 0 0 0 4px var(--ring); }
    .nav-btn:hover, .play-btn:hover, .repeat-btn:hover { transform: scale(1.1); border-color: var(--accent-glow); }
    .nav-btn.disabled { opacity: 0.4; cursor: not-allowed; transform: none; border-color: #475569; }
    .back-button { color: var(--text-muted); text-decoration: none; }
    .back-button:hover { color: var(--text-light); }
    #celebrationCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
  </style>
</head>
<body>
  
  <canvas id="celebrationCanvas"></canvas>

  <div class="container">
    <header class="surah-header">
      <h1 id="surahNameEl">جاري التحميل...</h1>
      <p id="ayahNumEl"></p>
    </header>
    
    <main class="main-content">
        <div class="surah-image-container">
            <img id="surahImage" src="https://placehold.co/800x400/1e293b/94a3b8?text=🖼️" alt="صورة توضيحية للسورة" class="surah-image">
        </div>
        <div id="ayahText">بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ</div>
        <audio id="audioPlayer"></audio>
        <div class="player-controls">
            <a id="prevBtn" class="nav-btn" href="#">&#9654;</a>
            <button id="playPauseBtn" class="play-btn">▶</button>
            <a id="nextBtn" class="nav-btn" href="#">&#9664;</a>
            <button id="repeatBtn" class="repeat-btn" title="تكرار الآية">🔁</button>
        </div>
    </main>

    <a href="index.html" class="back-button">العودة للفهرس</a>
  </div>

  <script>
    const surahNameEl = document.getElementById('surahNameEl');
    const ayahNumEl = document.getElementById('ayahNumEl');
    const ayahTextEl = document.getElementById('ayahText');
    const audioPlayer = document.getElementById('audioPlayer');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const repeatBtn = document.getElementById('repeatBtn');
    const surahImage = document.getElementById('surahImage');
    const canvas = document.getElementById('celebrationCanvas');
    const ctx = canvas.getContext('2d');

    let surahData = { ayahs: [] };
    let currentAyahIndex = 0;
    let isRepeating = false;
    
    window.onload = async function() {
      const params = new URLSearchParams(window.location.search);
      const surahNum = params.get('num');
      const surahName = params.get('name');
      
      if (!surahNum) { return; }

      document.title = `وردد | ${surahName}`;
      surahNameEl.textContent = `سورة ${surahName}`;
      
      try {
        const response = await fetch(`https://api.alquran.cloud/v1/surah/${surahNum}/quran-uthmani`);
        const json = await response.json();
        if (json.code !== 200) throw new Error(json.data);
        surahData = json.data;
        if (surahData.number !== 1 && surahData.ayahs[0].text.startsWith("بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ")) {
            surahData.ayahs.shift(); 
        }
        updateAyah();
      } catch (error) {
        ayahTextEl.textContent = "عفواً، حدث خطأ أثناء تحميل بيانات السورة.";
      }
      setupEventListeners();
      updateNavButtons();
    };

    function setupEventListeners() {
      playPauseBtn.addEventListener('click', togglePlayPause);
      nextBtn.addEventListener('click', nextAyah);
      prevBtn.addEventListener('click', prevAyah);
      repeatBtn.addEventListener('click', toggleRepeat);
      audioPlayer.addEventListener('ended', onAudioEnded);
      audioPlayer.addEventListener('play', () => { playPauseBtn.textContent = '⏸'; });
      audioPlayer.addEventListener('pause', () => { playPauseBtn.textContent = '▶'; });
    }
    
    function updateAyah() {
      if (!surahData.ayahs.length) return;
      const ayah = surahData.ayahs[currentAyahIndex];
      ayahTextEl.textContent = ayah.text;
      ayahNumEl.textContent = `الآية رقم ${ayah.numberInSurah}`;
      
      // *** التعديل الجديد هنا: تحديث الصورة مع كل آية ***
      // ملحوظة: خلي أسماء الصور أرقام بس (1.png, 2.png) مش (S1.png) عشان الكود ده يشتغل
      surahImage.src = `/assets/images/${surahData.number}/${ayah.numberInSurah}.png`;
      surahImage.alt = `صورة توضيحية للآية ${ayah.numberInSurah} من سورة ${surahData.name}`;

      const surahNumPadded = String(surahData.number).padStart(3, '0');
      const ayahNumPadded = String(ayah.numberInSurah).padStart(3, '0');
      audioPlayer.src = `https://everyayah.com/data/Husary_Muallim_128kbps/${surahNumPadded}${ayahNumPadded}.mp3`;
      playAudio();
      updateNavButtons();
    }
    
    async function playAudio() {
        try { await audioPlayer.play(); } catch (err) { console.log("Auto-play was prevented."); }
    }
    function togglePlayPause() { if (audioPlayer.paused) { playAudio(); } else { audioPlayer.pause(); } }
    function onAudioEnded() {
        if (isRepeating) { audioPlayer.currentTime = 0; playAudio(); } 
        else if (currentAyahIndex < surahData.ayahs.length - 1) { nextAyah(); } 
        else { playPauseBtn.textContent = '▶'; triggerCelebration(); }
    }
    function nextAyah(e) { if(e) e.preventDefault(); if (currentAyahIndex < surahData.ayahs.length - 1) { currentAyahIndex++; updateAyah(); } }
    function prevAyah(e) { if(e) e.preventDefault(); if (currentAyahIndex > 0) { currentAyahIndex--; updateAyah(); } }
    function toggleRepeat(){ isRepeating = !isRepeating; repeatBtn.classList.toggle('active', isRepeating); }
    function updateNavButtons() {
        prevBtn.classList.toggle('disabled', currentAyahIndex === 0);
        nextBtn.classList.toggle('disabled', currentAyahIndex === surahData.ayahs.length - 1);
    }

    let particles = [];
    function triggerCelebration() { /* ... الكود زي ما هو ... */ }
    function animateCelebration() { /* ... الكود زي ما هو ... */ }
    function hexToRgb(h) { /* ... الكود زي ما هو ... */ }

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW reg failed: ', err));
      });
    }
  </script>
</body>
</html>